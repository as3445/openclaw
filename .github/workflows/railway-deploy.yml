name: Trigger Railway Deploy

on:
  push:
    branches: [main]

jobs:
  trigger-deploy:
    runs-on: ubuntu-latest
    # Only run in the fork, not upstream openclaw
    if: github.repository == 'as3445/openclaw'
    steps:
      - name: Push version bump to template repo
        run: |
          git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/as3445/openclaw-railway-template.git /tmp/tpl
          cd /tmp/tpl
          git config user.email "nox@openclaw.ai"
          git config user.name "Nox (CI)"
          echo "${{ github.sha }}" > .openclaw-version
          git add .openclaw-version
          git diff --cached --quiet && echo "No change" && exit 0
          git commit -m "deploy: openclaw $(echo ${{ github.sha }} | cut -c1-8)"
          git push

      - name: Trigger Railway redeploy
        run: |
          curl -s -X POST "https://backboard.railway.com/graphql/v2" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"query":"mutation { serviceInstanceRedeploy(serviceId: \"28f77607-9c57-4a57-bd67-cf210969047b\") }"}' \
            -o /dev/null -w "HTTP %{http_code}\n"
          echo "Railway redeploy triggered"
